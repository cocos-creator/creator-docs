# Auth Service (AppGallery Connect) Quick Start

AppGallery Connect provides a cloud-based [Auth Service](https://developer.huawei.com/consumer/en/doc/development/AppGallery-connect-Guides/agc-auth-service-introduction) and SDKs to help you quickly build a secure and reliable user authentication system for your apps to verify user identity.

The AppGallery Connect auth service supports multiple authentication methods and is seamlessly integrated with other Serverless services to help you secure user data based on simple rules that you have defined.

### Functions

By using the AppGallery Auth Service SDK, you can integrate one or more of the following authentication methods into your app for achieving easy and efficient user registration and sign-in.

- Self-owned account: Your self-owned account is used to support the access of your existing authentication system so that your existing users can access other serverless services in a secure manner.
- Anonymous account: Anonymous accounts can be used to access your apps as visitors. The auth service can assign user IDs to your app visitors so that they can access other serverless services in a secure manner. A visitor can be registered as a formal user and retain the original user ID to ensure service continuity.
- Third-party accounts: AppGallery Connect allows user identity to be verified by using third-party authentication services. The AppGallery Auth Service SDK supports the following accounts for user identity verification:

  - HUAWEI ID 
  - HUAWEI Game Service account
  - Mobile Number 
  - Email account
  - WeChat account
  - Weibo account
  - QQ account 

  The following accounts, are supported **only at sites outside China**. You can use these authentication modes when the data storage location you select resides in Germany, Singapore, or Russia. The **Google account** and **Google Play Game account** authentication modes are supported only on devices installing Google Mobile Services (GMS).

  - Google account
  - Google Play Game account
  - Facebook account
  - Twitter account

### Service Process

- Obtain the authentication credential

  The authentication method determines how you can obtain the authentication credential.
  
  - For a third-party account, the authentication credential is the OAuth token issued by the third-party auth service.
  - For an anonymous account, the authentication credential is the unified identifier generated by the on-device SDK for the app installation instance.
  - For a self-created account, the authentication credential is the token generated by the existing authentication system through the Server SDK.

- Report the authentication credential.

  The app reports the authentication credential to the auth service through the AppGallery Auth Service SDK.

- Verify the authentication credential.

  The auth service verifies authentication credential in the cloud.

- Display the authentication result.

  The auth service sends the authentication result to the app. At this moment:

  - The app can access and maintain the basic personal information (nickname and profile picture) of the user.
  - The app can access and operate data protected by security rules in other Serverless services.
 
## Enable Auth Service

- Use Cocos Creator to open the project that needs to be connected to Auth Service.

- Click on **Panel -> Service** in the menu bar to open the Service panel, select Auth Service to go to the service detail page, and then click on the **Enable** button in the top right to enable the service. For details, please refer to the Cocos Service [Operation Guide](./index.md#usage) documentation.

  ![](agc-auth/auth-panel.png)

- Find your project from the project list and click the app for which you need to enable Auth Service on the project card. Go to **Build > Auth Service**. If it is the first time that you use Auth Service, click **Enable now** in the upper right corner.

  ![](agc-auth/auth-open.png)

- Select the required authentication method, click the **Enable** button on the right. In the dialog box that is displayed, configure app information. Required information can be obtained refer to AGC Auth Service document - [Enabling Auth Service](https://developer.huawei.com/consumer/en/doc/development/AppGallery-connect-Guides/agc-auth-service-getstarted#h1-1590395363254-0).

  ![](agc-auth/auth-console1.png)

  ![](agc-auth/auth-console2.png)

- After console setting, return to the Creator service panel, check the required authentication mode to be enabled, and configure app information for client.

  ![](agc-auth/auth-params.jpg)

### Configs HUAWEI Config file

Most of HUAWEI Kits need the `agconnect-services.json` configuration file. If there are operations such as newly opened services, please update the file in time.

- Sign in to [AppGallery Connect](https://developer.huawei.com/consumer/en/service/josp/agc/index.html) find your project from the project list and select the app on the project card.

- On the **Project Setting** page, click the configuration file **agconnect-services.json** to download it. The `agconnect-services.json` file **must be copied manually** to the settings directory of the project directory after downloading or updating.

  ![](agc-auth/auth-configfile.png)

### Verify whether the service is integrated successfully

- Let's take **HUAWEI ID** authentication mode as an example. Log in to [AppGallery Connect](https://developer.huawei.com/consumer/en/service/josp/agc/index.html) console, find your project and go to **Build > Auth Service**. enable **HUAWEI ID** authentication method and fill in the parameters.

  ![](agc-auth/auth-console3.jpg)

- Add simple code to the script.

  ```js
  huawei.agc.auth.authService.switchAuthType(huawei.agc.auth.AuthProvider.HMS_Provider);
  huawei.agc.auth.authService.login();
  ```

- You can [publish to the Android platform](../publish/publish-native.md) after the code is added. Please make sure that the **Package Name** on the **Build** panel is consistent with the **Package Name** set in the AppGallery Connect console.

- Run it on a phone, if the Huawei ID login interface appears, which means the integrate is successful.

  ![](agc-auth/auth-verify.png)

## Sample Project

Developer can get a quick taste of the Analytics Kit with the sample project.

- Click on the **Sample** button in the Analytics Kit service panel, clone or download, and open the project in Cocos Creator.

- After enabling the Analytics Kit service and configuring the HUAWEI configuration file as described above, you can open the **Build** panel to compile the project by clicking **Project -> Build** in the Creator editor menu bar. Cocos Creator v2.4.1 and above, you could [publish to HUAWEI AppGallery Connect](../publish/publish-huawei-agc.md). Below Creator v2.4.1 could [publish to the Android platform](../publish/publish-native.md).

- Need to test on Huawei or Honor brand phones with HMS Core service installed.

- Once the Sample project is running on the phone, click the **Auth** button on the homepage for testing.

  ![](agc-auth/auth-sample.png)

## Developer Guide

The Auth Service plug-in in Cocos Service has unified encapsulation of various authentication methods of Java SDK. Please refer to this document and [Auth Service - API Document](https://docs.cocos.com/service/api/modules/huawei.agc.auth.html) for integrate using JavaScript.

### Listener and callback

The Auth Service plug-in encapsulates the callbacks of each login method in a unified manner. The developer needs to set up a listener and bind the method, and the callback logic is unified in the binding method.

回调枚举值 [AuthRetCode](https://docs.cocos.com/service/api/modules/huawei.agc.auth.authretcode.html) 有三种长度类型：

- 四位数的 **1XXX** 为认证服务插件封装的 **统一回调事件枚举值**，开发者需要对关键事件进行处理。
- 九位数的 **2038XXXXX** 为 SDK 返回的后端服务器的错误信息。
- 一位数的从 **1 ~ 7** 为 SDK 内部错误信息。

后面两种长度类型都是 SDK 的 错误码，可以根据需要进行处理。

The callback enumeration value [AuthRetCode](https://docs.cocos.com/service/api/modules/huawei.agc.auth.authretcode.html) has three length types:

- The four-digit **1XXX** is the **unified callback event enumeration value** defined by the Auth Service plug-in. Developers need to handle with key events. 
- The nine-digit **2038XXXXX** indicate backend server errors. 
- The one-digit **1 ~ 7** indicate SDK internal errors. 

The latter two length types are SDK error codes, which can be handled as needed.

**Example**:

```js
huawei.agc.auth.authService.setAuthListener(this.onAuthResult, this));

onAuthResult: function (code, msg) {
    switch (code) {
      ...
    }
}
```

### switchAuthType

`switchAuthType(authType: AuthProvider): void`

Select the current authentication login method. You need to call this method first, before calling other methods such as `login`. The supported authentication login method can be obtained by [getSupportAuthType](#getsupportauthtype).

**Parameter Description**:

| Parameter | Description | 
| :---------- | :------------- |  
|  authType  | [enumeration value of [AuthProvider](https://docs.cocos.com/service/api/enums/huawei.agc.auth.authprovider.html) type. | 

**Example**:

```js
huawei.agc.auth.authService.switchAuthType(huawei.agc.auth.AuthProvider.HMS_Provider);
```

### login

`login(): void`

Call the **login** method of the current authentication method.

**Example**:

```js
huawei.agc.auth.authService.login();
```

### logout

`logout(): void`

Call the **logout** method of the current authentication method.

**Example**:

```js
huawei.agc.auth.authService.logout();
```

### getUserInfo

`getUserInfo(): any`

Get current user info. Return information may include `isAnonymous` is annoymous account, `uid` user ID, `displayName` display/nick name, `photoUrl` icon photo url, `email` email address, `phone` mobile phone number, `providerId` auth provider id, `providerInfo` auth provider info, `emailVerified` is email verified, `passwordSetted` is password setted.

**Example**:

```js
let userInfo = huawei.agc.auth.authService.getUserInfo();
console.log('getUserInfo...', 'info =', JSON.stringify(userInfo));
```

### setLoginInfo 

`setLoginInfo(loginInfo: any): void`

Set user registration or login information (for phone number and email address authentication methods only), the method needs to be called before other methods.

**Parameter Description**:

| Parameter | Description | 
| :---------- | :------------- |  
|  loginInfo  | JSON Object, according to the needs of mobile phone or email authentication login method, input the following parameters::<br>email: for email authentication method<br>phoneNumber: for phone authentication method<br>countryCode: for phone authentication method<<br>verifyCode: call method `register` or `getVerifyCode`, user receives the verification code, and needs to let the user fill in the interface and reset the login information through the verification code<br>action: fill the `register` or `reset` | 

| Parameter | Description | 
| :---------- | :------------- |  
|  loginInfo  | JSON Object, according to the needs of mobile phone or email authentication login method, require the following parameters:<br>email: Email address, for email authentication method required.<br>phoneNumber: Mobile number, for phone authentication method required.<br>countryCode: Country/Region code, for phone authentication method required.<br>verifyCode: The verification code that the user fills in after calling the register or getVerifyCode method, used to reset the login information.<br>action: register (for registration) or reset (for reset). | 

**Example**:

```js
let loginInfo = {
  email: '953xxxxx@gmail.com',
  phoneNumber: "181XXXXXXXX",
  countryCode: "86",
  verifyCode: code,
  action: "register",
}
huawei.agc.auth.authService.setLoginInfo(loginInfo);
```

### register

`register(): void`

User register (for phone number and email address authentication methods only).

**Example**:

```js
huawei.agc.auth.authService.register();
```

### getVerifyCode

`getVerifyCode(): void`

Get verification code (for phone number and email address authentication methods only).

**Example**:

```js
huawei.agc.auth.authService.getVerifyCode();
```

### getSupportAuthType

`getSupportAuthType(): string`

Get supported authentication methods, such as "[0, 1, 2]", refer to [AuthProvider](https://docs.cocos.com/service/api/enums/huawei.agc.auth.authprovider.html) type.

**Example**:

```js
let supAuthType = huawei.agc.auth.authService.getSupportAuthType();
console.log("getSupportAuthType...", "type = ", supAuthType);
```

### getToken

`getToken(forceRefresh: boolean): void`

Obtains the access token of a user from AppGallery Connect, asynchronous update result. Callback code is `huawei.agc.auth.AuthRetCode.GET_TOKEN_SUCCESS` or `huawei.agc.auth.AuthRetCode.GET_TOKEN_FAIL`.

**Parameter Description**:

| Parameter | Description | 
| :---------- | :------------- |  
|  forceRefresh  | Indicates whether to forcibly update the access token of a user.<br>**true**: Forcible update is required.<br>**false**: the cached access token is obtained. | 

**Example**:

```js
huawei.agc.auth.authService.getToken(true);
```

### link

`link(authType: AuthProvider): void`

Associates the current user with a new login method.

**Parameter Description**:

| Parameter | Description | 
| :---------- | :------------- |  
|  authType  | enumeration value of [AuthProvider](https://docs.cocos.com/service/api/enums/huawei.agc.auth.authprovider.html) type | 

**Example**:

```js
huawei.agc.auth.authService.link(huawei.agc.auth.AuthProvider.HMS_Provider);
```

### updateProfile

`updateProfile(displayName: string, photoUrl: string): void`

Updates information (profile image and nickname) for the current user.

This API verifies the access token and refresh token of a user. Ensure that the refresh token is within its validity period. Otherwise, result code 203817986 will be returned, indicating that the user's refresh token has expired. When receiving the result code, prompt your user to sign in again so that you can obtain the new access token and refresh token.

**Parameter Description**:

| Parameter | Description | 
| :---------- | :------------- |  
|  displayName  | display/nick name | 
|  photoUrl  | icon photo url |

**Example**:

```js
huawei.agc.auth.authService.updateProfile("name1", photoUrl);
```

### updatePassword

`updatePassword(newPassword: string, verifyCode: string, provider: AuthProvider): void`

Updates the current user's password, asynchronous update result. After the password is updated successfully, the user's access token is refreshed and the user is asked to re-sign in. Otherwise, the API call may fail due to the access token matching failure. Refer to AGC Auth Service document - [updatePassword](https://developer.huawei.com/consumer/en/doc/development/AppGallery-connect-References/agconnectuser#updatePassword).

**Parameter Description**:

| Parameter | Description | 
| :---------- | :------------- |  
|  newPassword  | new password | 
|  verifyCode  | verification code |
|  provider  | enumeration value of [AuthProvider](https://docs.cocos.com/service/api/enums/huawei.agc.auth.authprovider.html) type, which is used to distinguish the email address account from the phone number account. |

**Example**:

```js
huawei.agc.auth.authService.updatePassword("neWPaSSwOrd", "1234", huawei.agc.auth.AuthProvider.Phone_Provider);
```

### updateEmail

Updates the email address of the current user, asynchronous update result. Before calling this method, call the `getVerifyCode` function to apply for a verification code of the new email address. The verification code is used to verify that the current user owns the new email address. Refer to AGC Auth Service document - [updateEmail](https://developer.huawei.com/consumer/en/doc/development/AppGallery-connect-References/agconnectuser#h2-1577435497514).

**Parameter Description**:

| Parameter | Description | 
| :---------- | :------------- |  
|  newEmail  | new email address | 
|  newVerifyCode  | verification code |

**Example**:

```js
huawei.agc.auth.authService.updateEmail("newUser1@gmail.com", "1234");
```

### updatePhone

`updatePhone(countryCode: string, phoneNumber: string, newVerifyCode: string): void`

Updates the mobile phone number of the current user, asynchronous update result. Before calling this method, call the `getVerifyCode` function to apply for a verification code of the new email address. The verification code is used to verify that the current user owns the new email address. Refer to AGC Auth Service document - [updatePhone](https://developer.huawei.com/consumer/en/doc/development/AppGallery-connect-References/agconnectuser#updatePhone).

**Parameter Description**:

| Parameter | Description | 
| :---------- | :------------- |  
|  countryCode  | Country/Region code. For example, 86 indicates China, 49 indicates Germany, 7 indicates Russia, and 65 indicates Singapore. This parameter supports multiple formats. Taking China as an example, the code can be 86, 0086, or +86. | 
|  phoneNumber  | Mobile number. The number does not include the plus sign (+) and country/region code. For example, for the mobile number +86132xxxxxxxx, the value of this parameter is 132xxxxxxxx. |
|  verifyCode  | verification code |

**Example**:

```js
huawei.agc.auth.authService.updateEmail("0086", "132xxxxxxxx", "1234");
```

### getUserExtra

`getUserExtra(): void`

Obtains UserExtra of the current user, asynchronous update result. This API verifies the access token and refresh token of a user. Ensure that the refresh token is within its validity period. Otherwise, result code `INVALID_REFRESH_TOKEN = 203817986` will be returned, indicating that the user's refresh token has expired. Refer to AGC Auth Service document - [getUserExtra](https://developer.huawei.com/consumer/en/doc/development/AppGallery-connect-References/agconnectuser#getUserExtra).

**Example**:

```js
huawei.agc.auth.authService.getUserExtra();
```

### deleteUser

`deleteUser(): void`

Deletes the current user information and cache information from the AppGallery Connect server.

**Example**:

```js
huawei.agc.auth.authService.deleteUser();
```

### resetPassword

`resetPassword(emailOrPhone: string, newPassword: string, verifyCode: string, countryCode = ""): void`

Resets the password using a mobile number (for phone number and email address authentication methods only). If the `countryCode` parameter is sent, it is the mobile phone authentication method, otherwise it is email authentication method. Callback code is `huawei.agc.auth.AuthRetCode.RESET_PASS_SUCCESS` or `huawei.agc.auth.AuthRetCode.RESET_PASS_FAIL`.

**Parameter Description**:

| Parameter | Description | 
| :---------- | :------------- |  
|  emailOrPhone  | email address or mobile number | 
|  newPassword  | new password | 
|  verifyCode  | verification code |
|  countryCode  | Country/Region code. For example, 86 indicates China, 49 indicates Germany, 7 indicates Russia, and 65 indicates Singapore. This parameter supports multiple formats. Taking China as an example, the code can be 86, 0086, or +86. |

**Example**:

```js
huawei.agc.auth.authService.resetPassword( "132xxxxxxxx", "neWPaSSwOrd", "1234", "0086");

huawei.agc.auth.authService.resetPassword( "newUser1@gmail.com", "neWPaSSwOrd", "1234");
```

## API Documentation

Please refer to the [Auth Service - API Documentation](https://docs.cocos.com/service/api/modules/huawei.agc.auth.html).